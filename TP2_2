import cv2
import numpy as np
import matplotlib.pyplot as plt
import os

# Constantes
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
IMAGE_DIR = BASE_DIR
RESULTS_DIR = os.path.join(BASE_DIR, 'results')
FIGURE_SIZE = (15, 10)

def load_image(image_path):
    """
    Charger l'image en niveaux de gris.
    """
    image = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)
    if image is None:
        raise ValueError(f"Impossible de charger l'image : {image_path}")
    return image

def calculate_histogram(image):
    """
    Calculer l'histogramme de l'image.
    """
    hist = cv2.calcHist([image], [0], None, [256], [0, 256])
    return hist.flatten()

def mean_filter(image, kernel_size):
    """
    Appliquer un filtre moyenneur.
    """
    return cv2.blur(image, (kernel_size, kernel_size))

def gaussian_filter(image, kernel_size, sigma):
    """
    Appliquer un filtre gaussien.
    """
    return cv2.GaussianBlur(image, (kernel_size, kernel_size), sigma)

def median_filter(image, kernel_size):
    """
    Appliquer un filtre médian.
    """
    return cv2.medianBlur(image, kernel_size)

def max_filter(image, kernel_size):
    """
    Appliquer un filtre maximum (dilatation).
    """
    kernel = np.ones((kernel_size, kernel_size), np.uint8)
    return cv2.dilate(image, kernel)

def min_filter(image, kernel_size):
    """
    Appliquer un filtre minimum (érosion).
    """
    kernel = np.ones((kernel_size, kernel_size), np.uint8)
    return cv2.erode(image, kernel)

def visualize_results(original, processed, method_name, params_str):
    """
    Créer une figure avec visualisation de l'image originale, traitée et leurs histogrammes.
    """
    fig, axes = plt.subplots(2, 2, figsize=FIGURE_SIZE)
    fig.suptitle(f'Réduction de Bruit - {method_name}', fontsize=16)

    # Image originale
    axes[0, 0].imshow(original, cmap='gray')
    axes[0, 0].set_title('Image Originale')
    axes[0, 0].axis('off')

    # Histogramme original
    hist_orig = calculate_histogram(original)
    axes[0, 1].plot(hist_orig, color='black')
    axes[0, 1].set_title('Histogramme Original')
    axes[0, 1].set_xlabel('Valeur de Pixel')
    axes[0, 1].set_ylabel('Fréquence')
    axes[0, 1].grid(True)

    # Image traitée
    axes[1, 0].imshow(processed, cmap='gray')
    axes[1, 0].set_title(f'Image Filtrée - {params_str}')
    axes[1, 0].axis('off')

    # Histogramme traité
    hist_proc = calculate_histogram(processed)
    axes[1, 1].plot(hist_proc, color='black')
    axes[1, 1].set_title('Histogramme Filtré')
    axes[1, 1].set_xlabel('Valeur de Pixel')
    axes[1, 1].set_ylabel('Fréquence')
    axes[1, 1].grid(True)

    plt.tight_layout()
    return fig

def save_result(figure, processed_image, image_name, method_folder, params_str):
    """
    Sauvegarder la figure et l'image traitée.
    """
    method_dir = os.path.join(RESULTS_DIR, method_folder)
    os.makedirs(method_dir, exist_ok=True)

    base_name = os.path.splitext(image_name)[0]
    fig_name = f"{base_name}_{params_str}.png"
    fig_path = os.path.join(method_dir, fig_name)
    figure.savefig(fig_path, dpi=300, bbox_inches='tight')
    plt.close(figure)

    # Sauvegarder l'image traitée
    img_name = f"{base_name}_{params_str}_processed.png"
    img_path = os.path.join(method_dir, img_name)
    cv2.imwrite(img_path, processed_image)

def create_comparison_grid(image_path):
    """
    Créer une grille de comparaison pour une image.
    """
    original = load_image(image_path)
    img_name = os.path.basename(image_path)
    base_name = os.path.splitext(img_name)[0]

    # Charger les résultats existants pour kernel=5
    mean_path = os.path.join(RESULTS_DIR, 'mean_filter', f'{base_name}_kernel5_processed.png')
    gaussian_path = os.path.join(RESULTS_DIR, 'gaussian_filter', f'{base_name}_kernel5_sigma0_processed.png')
    median_path = os.path.join(RESULTS_DIR, 'median_filter', f'{base_name}_kernel5_processed.png')
    max_path = os.path.join(RESULTS_DIR, 'max_filter', f'{base_name}_kernel5_processed.png')
    min_path = os.path.join(RESULTS_DIR, 'min_filter', f'{base_name}_kernel5_processed.png')

    mean = cv2.imread(mean_path, cv2.IMREAD_GRAYSCALE)
    gaussian = cv2.imread(gaussian_path, cv2.IMREAD_GRAYSCALE)
    median = cv2.imread(median_path, cv2.IMREAD_GRAYSCALE)
    max_f = cv2.imread(max_path, cv2.IMREAD_GRAYSCALE)
    min_f = cv2.imread(min_path, cv2.IMREAD_GRAYSCALE)

    fig, axes = plt.subplots(6, 2, figsize=(20, 24))
    fig.suptitle(f'Comparaison des Filtres - {img_name}', fontsize=16)

    methods = [
        ('Originale', original),
        ('Filtre Moyenneur (kernel=5)', mean),
        ('Filtre Gaussien (kernel=5, sigma=0)', gaussian),
        ('Filtre Médian (kernel=5)', median),
        ('Filtre Maximum (kernel=5)', max_f),
        ('Filtre Minimum (kernel=5)', min_f)
    ]

    for i, (title, img) in enumerate(methods):
        axes[i, 0].imshow(img, cmap='gray')
        axes[i, 0].set_title(title)
        axes[i, 0].axis('off')

        hist = calculate_histogram(img)
        axes[i, 1].plot(hist, color='black')
        axes[i, 1].set_title(f'Histogramme - {title}')
        axes[i, 1].set_xlabel('Valeur de Pixel')
        axes[i, 1].set_ylabel('Fréquence')
        axes[i, 1].grid(True)

    plt.tight_layout()
    comp_dir = os.path.join(RESULTS_DIR, 'comparisons')
    os.makedirs(comp_dir, exist_ok=True)
    comp_path = os.path.join(comp_dir, f'{base_name}_comparison.png')
    fig.savefig(comp_path, dpi=300, bbox_inches='tight')
    plt.close(fig)

def main():
    """
    Pipeline principal d'exécution.
    """
    os.makedirs(RESULTS_DIR, exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'mean_filter'), exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'gaussian_filter'), exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'median_filter'), exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'max_filter'), exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'min_filter'), exist_ok=True)
    os.makedirs(os.path.join(RESULTS_DIR, 'comparisons'), exist_ok=True)

    images = ['tp21.png', 'tp22.png', 'tp23.png', 'tp24.png']

    for img_name in images:
        img_path = os.path.join(IMAGE_DIR, img_name)
        original = load_image(img_path)

        # Filtre moyenneur
        for kernel_size in [3, 5, 7, 9, 11]:
            processed = mean_filter(original, kernel_size)
            params_str = f'kernel{kernel_size}'
            fig = visualize_results(original, processed, 'Filtre Moyenneur', params_str)
            save_result(fig, processed, img_name, 'mean_filter', params_str)

        # Filtre gaussien
        gaussian_params = [
            (3, 0),
            (5, 0),
            (7, 0),
            (5, 1.0),
            (5, 2.0),
            (9, 2.0)
        ]
        for kernel_size, sigma in gaussian_params:
            processed = gaussian_filter(original, kernel_size, sigma)
            params_str = f'kernel{kernel_size}_sigma{sigma}'
            fig = visualize_results(original, processed, 'Filtre Gaussien', params_str)
            save_result(fig, processed, img_name, 'gaussian_filter', params_str)

        # Filtre médian
        for kernel_size in [3, 5, 7, 9, 11]:
            processed = median_filter(original, kernel_size)
            params_str = f'kernel{kernel_size}'
            fig = visualize_results(original, processed, 'Filtre Médian', params_str)
            save_result(fig, processed, img_name, 'median_filter', params_str)

        # Filtre maximum
        for kernel_size in [3, 5, 7, 9]:
            processed = max_filter(original, kernel_size)
            params_str = f'kernel{kernel_size}'
            fig = visualize_results(original, processed, 'Filtre Maximum', params_str)
            save_result(fig, processed, img_name, 'max_filter', params_str)

        # Filtre minimum
        for kernel_size in [3, 5, 7, 9]:
            processed = min_filter(original, kernel_size)
            params_str = f'kernel{kernel_size}'
            fig = visualize_results(original, processed, 'Filtre Minimum', params_str)
            save_result(fig, processed, img_name, 'min_filter', params_str)

    # Génération des comparaisons
    for img_name in images:
        create_comparison_grid(os.path.join(IMAGE_DIR, img_name))

if __name__ == '__main__':
    main()
